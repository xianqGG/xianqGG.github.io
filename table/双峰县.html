const main = async () => {
  const $ = document.querySelector.bind(document);
  /**
   * @type {HTMLElement}
   */
  const $title = $('#title');
  const $tail = $('#tail');
  /**
   * @type {HTMLElement}
   */
  const $table = $('#table');

  const query = new URLSearchParams(location.search.split('?')[1]);
  const url = `https://example.com/${query.get('id')}.txt`;

  let [[title], ...data] = await fetch(url)
    .then((res) => res.text())
    .catch(() => '')
    .then((str) =>
      str
        .split(/^$/gm)
        .map((it) => it.trim())
        .filter(Boolean)
        .map((it) =>
          it
            .split(/\n|\r/)
            .map((subit) => subit.trim())
            .filter(Boolean),
        ),
    );

  data = formatData(data);

  let tail = '';
  const lastdata = data[data.length - 1];
  if (lastdata && lastdata.length === 1) {
    tail = lastdata[0];
    data = data.slice(0, data.length - 1);
  }

  const maxCount = Math.max(...data.map((it) => it.length));

  document.title = title;
  $title.innerHTML = title;
  $table.innerHTML =
    '<tbody>' +
    data
      .map((rows) =>
        Array.from({ length: maxCount })
          .map((_, i) => renderItem(rows[i]))
          .join(''),
      )
      .map((rowStr) => `<tr>${rowStr}</tr>`)
      .join('') +
    '</tbody>';
  $tail.innerHTML = tail;

  // 打开txt文件内的网址
  window.open(url, '_blank');
};

main().catch((err) => {
  console.error(err);
  alert('错误：' + err.message);
});