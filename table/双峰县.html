<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>双峰县田长制</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #F5F5DC;
    }

    #pic {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      margin-top: 25px;
    }

    #pic img {
      object-fit: contain;
      width: 100%;
      height: auto;
    }

    .app {
      width: 700px;
      max-width: 100%;
      margin: 0 auto;
      padding: 12px;
    }

    #table {
      width: 100%;
      border-collapse: collapse;
    }

    tr {
      height: 30px;
    }

    tr:nth-child(even) {
      background-color: transparent;
    }

    tr:not(:last-child) {
      border-bottom: 1px solid rgba(221, 221, 221, 0.5);
    }

    th {
      font-size: 16px;
      font-weight: normal;
      color: #333;
      padding: 0 4px;
      text-align: left;
    }

    th + th {
      border-left: 1px solid rgba(221, 221, 221, 0.5);
    }

    tr th:first-of-type {
      font-weight: bolder;
      width: 68px;
    }

    a[href^='tel'] {
      color: #6cf;
    }
  </style>
</head>

<body>
  <picture id="pic"></picture>
  <div class="app">
    <table id="table"></table>
    <h1 id="tail"></h1>
  </div>

  <script>
    const query = new URLSearchParams(location.search);
    const suffix = (location.pathname.split("/").at(-1) || "").replace(
      /\.html$/i,
      ""
    );
    const id = query.get("id");
    const $pic = document.getElementById("pic");
    $pic.innerHTML =
      [".jpg", ".png", ".jpeg"]
        .map((ext) => suffix + "/" + id + ext)
        .map((src) => `<source srcset="${src}" />`)
        .join("") + "<img>";

    const tags = {
      phone: (phone = '') => `<a href="tel:${phone}">${phone}</a>`,
    };

    const renderItem = (th = '') => {
      th = th || '';
      th = th
        .replace(/\d{4}-\d+/g, tags.phone)
        .replace(/\d{11}/g, tags.phone);
      return `<th>${th}</th>`;
    };

    const formatData = (data) => {
      return data.map((row) => row.map((cell) => cell.replace(/&/g, "<br/>")));
    };

    const main = async () => {
      const $ = document.querySelector.bind(document);
      const $tail = $('#tail');
      const $table = $('#table');

      const query = new URLSearchParams(location.search.split('?')[1]);
      const path = `双峰县/${query.get('id')}.txt?${Date.now()}`;

      let [[title], ...data] = await fetch(path)
        .then((res) => res.text())
        .catch(() => '')
        .then((str) =>
          str
            .split(/^$/gm)
            .map((it) => it.trim())
            .filter(Boolean)
            .map((it) =>
              it
                .split(/\n|\r/)
                .map((subit) => subit.trim())
                .filter(Boolean),
            ),
        );

      data = formatData(data);

      let tail = '';
      const lastdata = data[data.length - 1];
      if (lastdata && lastdata.length === 1) {
        tail = lastdata[0];
        data = data.slice(0, data.length - 1);
      }

      const maxCount = Math.max(...data.map((it) => it.length));

      document.title = title;
      $table.innerHTML =
        '<tbody>' +
        data
          .map((rows) =>
            Array.from({ length: maxCount })
              .map((_, i) => renderItem(rows[i]))
              .join(''),
          )
          .map((rowStr) => `<tr>${rowStr}</tr>`)
          .join('') +
        '</tbody>';
      $tail.innerHTML = tail;
    };

    main().catch((err) => {
      console.error(err);
      alert('错误：' + err.message);
    });
  </script>
</body>

<p>这是页面底部的文字。</p>
<style>
  .footer p {
    text-align: center;
    font-size: 16px;
    color: #333;
  }
</style>

</html>